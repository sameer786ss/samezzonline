---
import Layout from '~/layouts/PageLayout.astro';
import HeroText from '~/components/widgets/HeroText.astro';
import Form from '~/components/ui/Form.astro';

const metadata = {
  title: 'Login',
};
---

<Layout metadata={metadata}>
  <HeroText tagline="Login" title="Welcome Back!" />
  <div class="flex flex-col max-w-xl mx-auto rounded-lg backdrop-blur border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900 shadow p-4 sm:p-6 lg:p-8 w-full">
    <div id="login-form">
      <Form
        inputs={[
          {
            type: 'email',
            name: 'email',
            label: 'Email',
          },
          {
            type: 'password',
            name: 'password',
            label: 'Password',
          },
        ]}
        button="Login"
      />
    </div>
  </div>
</Layout>

<script type="module">
  import { db } from '../../firebase/firebase';
  import { collection, query, where, getDocs } from 'firebase/firestore';

  const form = document.querySelector('#login-form form');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const email = form.email.value;
    const password = form.password.value;

    const q = query(collection(db, 'users'), where('email', '==', email));

    const querySnapshot = await getDocs(q);

    if (querySnapshot.empty) {
      alert('Invalid email or password.');
      return;
    }

    let userFound = false;
    querySnapshot.forEach((doc) => {
      if (doc.data().password === password) {
        userFound = true;
        localStorage.setItem('loggedInUser', JSON.stringify(doc.data()));
        alert('Login successful!');
        window.location.href = '/';
      }
    });

    if (!userFound) {
      alert('Invalid email or password.');
    }
  });
</script>
