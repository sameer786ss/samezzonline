---
import Layout from '~/layouts/PageLayout.astro';
import HeroText from '~/components/widgets/HeroText.astro';
---

<Layout metadata={{ title: 'Register' }}>
  <HeroText tagline="Register" title="Create an Account" />
  <div
    class="flex flex-col max-w-xl mx-auto rounded-lg backdrop-blur border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900 shadow p-4 sm:p-6 lg:p-8 w-full"
  >
    <div id="register-form-container">
      <form id="register-form">
        <div class="mb-4">
          <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Name</label>
          <input
            type="text"
            id="name"
            name="name"
            required
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm dark:bg-slate-800 dark:border-gray-600 dark:text-white"
          />
        </div>
        <div class="mb-4">
          <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email</label>
          <input
            type="email"
            id="email"
            name="email"
            required
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm dark:bg-slate-800 dark:border-gray-600 dark:text-white"
          />
        </div>
        <div class="mb-6">
          <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Password</label>
          <input
            type="password"
            id="password"
            name="password"
            required
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm dark:bg-slate-800 dark:border-gray-600 dark:text-white"
          />
        </div>
        <div id="error-message" class="hidden text-red-500 text-sm mb-4"></div>
        <button
          type="submit"
          class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
          >Register</button
        >
      </form>
    </div>
    <div class="mt-4">
        <button id="google-signin" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
            Sign up with Google
        </button>
    </div>
    <div class="mt-4">
        <button id="phone-signin" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
            Sign up with Mobile Number
        </button>
    </div>
    <div id="phone-form-container" class="hidden mt-4">
        <div class="mb-4">
            <label for="phone-number" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Phone Number</label>
            <input
            type="tel"
            id="phone-number"
            name="phone-number"
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm dark:bg-slate-800 dark:border-gray-600 dark:text-white"
            />
        </div>
        <div id="recaptcha-container"></div>
        <button id="send-code" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" disabled>
            Send Code
        </button>
        <div class="mb-4 mt-4">
            <label for="verification-code" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Verification Code</label>
            <input
            type="text"
            id="verification-code"
            name="verification-code"
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm dark:bg-slate-800 dark:border-gray-600 dark:text-white"
            />
        </div>
        <button id="verify-code" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            Verify Code
        </button>
    </div>
    <p class="text-center text-sm text-gray-500 mt-4">
      Already have an account? 
      <a href="/login" class="text-blue-600 hover:underline dark:text-blue-400">Log in</a>
    </p>
  </div>
</Layout>

<script type="module">
  import { db, auth } from '../../lib/firebase.ts';
  import { collection, addDoc, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
  import { GoogleAuthProvider, signInWithPopup, RecaptchaVerifier, signInWithPhoneNumber } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

  const form = document.querySelector('#register-form');
  const errorMessage = document.querySelector('#error-message');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    errorMessage.classList.add('hidden');

    const name = form.name.value;
    const email = form.email.value;
    const password = form.password.value;

    if (!name || !email || !password) {
      errorMessage.textContent = 'Please fill out all fields.';
      errorMessage.classList.remove('hidden');
      return;
    }

    try {
      // Check if user already exists
      const q = query(collection(db, 'users'), where('email', '==', email));
      const querySnapshot = await getDocs(q);

      if (!querySnapshot.empty) {
        errorMessage.textContent = 'User with this email already exists.';
        errorMessage.classList.remove('hidden');
        return;
      }

      const docRef = await addDoc(collection(db, 'users'), {
        name: name,
        email: email,
        password: password, // Note: Storing passwords in plaintext is not secure.
      });
      console.log('Document written with ID: ', docRef.id);
      alert('Registration successful! Please log in.');
      window.location.href = '/login';
    } catch (error) {
      console.error('Error registering user:', error);
      errorMessage.textContent = 'An unexpected error occurred. Please try again.';
      errorMessage.classList.remove('hidden');
    }
  });

  const googleSignInButton = document.querySelector('#google-signin');
  googleSignInButton.addEventListener('click', async () => {
    const provider = new GoogleAuthProvider();
    try {
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      const q = query(collection(db, 'users'), where('email', '==', user.email));
      const querySnapshot = await getDocs(q);
      if (querySnapshot.empty) {
        const docRef = await addDoc(collection(db, 'users'), {
            name: user.displayName,
            email: user.email,
        });
      }
      localStorage.setItem('loggedInUser', JSON.stringify({ name: user.displayName, email: user.email }));
      window.location.href = '/';
    } catch (error) {
      console.error('Error with Google Sign-In:', error);
    }
  });

  const phoneSignInButton = document.querySelector('#phone-signin');
  const phoneFormContainer = document.querySelector('#phone-form-container');
  const registerFormContainer = document.querySelector('#register-form-container');
  const sendCodeButton = document.querySelector('#send-code');
  const verifyCodeButton = document.querySelector('#verify-code');

  let recaptchaVerifier = null;

  phoneSignInButton.addEventListener('click', () => {
      registerFormContainer.classList.add('hidden');
      phoneFormContainer.classList.remove('hidden');
      if (!recaptchaVerifier) {
          recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
              'size': 'normal',
              'callback': (response) => {
                  sendCodeButton.disabled = false;
              },
              'expired-callback': () => {
                  sendCodeButton.disabled = true;
              }
          });
          recaptchaVerifier.render();
      }
  });

  sendCodeButton.addEventListener('click', async () => {
      const phoneNumber = document.querySelector('#phone-number').value;
      const appVerifier = recaptchaVerifier;

      try {
          const confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, appVerifier);
          window.confirmationResult = confirmationResult;
          alert('Verification code sent!');
      } catch (error) {
          console.error('Error sending verification code:', error);
          alert('Error sending verification code. Please try again.');
          recaptchaVerifier.render();
      }
  });

  verifyCodeButton.addEventListener('click', async () => {
      const code = document.querySelector('#verification-code').value;
      try {
          const result = await window.confirmationResult.confirm(code);
          const user = result.user;
          const q = query(collection(db, 'users'), where('phoneNumber', '==', user.phoneNumber));
          const querySnapshot = await getDocs(q);
          if (querySnapshot.empty) {
            const docRef = await addDoc(collection(db, 'users'), {
                phoneNumber: user.phoneNumber,
            });
          }
          localStorage.setItem('loggedInUser', JSON.stringify({ phoneNumber: user.phoneNumber }));
          window.location.href = '/';
      } catch (error) {
          console.error('Error verifying code:', error);
          alert('Invalid verification code. Please try again.');
      }
  });
</script>
